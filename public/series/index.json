[{"content":" æœ¬ç³»åˆ—ä¸»è¦ä½œä¸ºæœ¬äººå®ç°MIT6.5840ï¼ˆåŸMIT6.824ï¼‰çš„è®°å½•ã€‚è‹¥æœ‰é—®é¢˜ï¼Œæ•¬è¯·è°…è§£ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚\nä¼ é€é—¨ Raftè®ºæ–‡ï¼šè‹±æ–‡ç‰ˆ|ä¸­æ–‡ç‰ˆ\nå®éªŒè¦æ±‚ï¼šhttps://pdos.csail.mit.edu/6.824/labs/lab-raft.html\nRaftå®ç°å‚è€ƒå®ä¾‹ï¼šhttps://github.com/hashicorp/raft/tree/main\næ•°æ®ç»“æ„ æ•°æ®ç»“æ„çš„å®šä¹‰åŸºæœ¬å‚è€ƒäº†è®ºæ–‡çš„å›¾2\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 type Raft struct { mu sync.Mutex // Lock to protect shared access to this peer\u0026#39;s state peers []*labrpc.ClientEnd // RPC end points of all peers persister *Persister // Object to hold this peer\u0026#39;s persisted state me int // this peer\u0026#39;s index into peers[] dead int32 // set by Kill() // Your data here (2A, 2B, 2C). // Look at the paper\u0026#39;s Figure 2 for a description of what // state a Raft server must maintain. state State //RaftèŠ‚ç‚¹è§’è‰²ï¼ŒLeaderã€Candidateã€Follower currentTerm int //å½“å‰çš„é€‰æœŸ votedFor int //æŠ•ç¥¨çš„å¯¹è±¡ heartbeatTimeout time.Duration electionTimeout time.Duration lastElectionTime time.Time lastHeartbeatTime time.Time } type RequestVoteArgs struct { // Your data here (2A, 2B). Term int CandidateId int } type RequestVoteReply struct { // Your data here (2A). Term int VoteGranted bool } type AppendEntriesArgs struct { LeaderTerm int LeaderID int PrevLogIndex int PrevLogTerm int Entries []Entry LeaderCommit int } type AppendEntriesReply struct { FollowerTerm int Success bool } é€‰ä¸¾è¿‡ç¨‹ æ•´ä¸ªLab2Aå®ç°é¢†å¯¼äººé€‰ä¸¾ï¼Œä¸»è¦å°±æ˜¯å›´ç»•RaftèŠ‚ç‚¹çš„3ä¸ªåŸºç¡€è§’è‰²å±•å¼€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func (rf *Raft) ticker() { for !rf.killed() { rf.mu.Lock() state := rf.state rf.mu.Unlock() switch state { case Follower: fallthrough case Candidate: if rf.pastElectionTimeout() { rf.StartElection() } case Leader: heartbeat := false if rf.pastHeartbeatTimeout() { heartbeat = true rf.resetHeartbeatTimer() } rf.StartAppendEntries(heartbeat) } time.Sleep(tickInterval) } } Leaderçš„ä»»åŠ¡æ˜¯åœ¨å¿ƒè·³åˆ°æœŸæ—¶å‘é€æ–°çš„å¿ƒè·³ä¿¡å·ï¼Œå‘Šè¯‰å…¶ä»–èŠ‚ç‚¹â€œæˆ‘è¿˜æ´»ç€â€ï¼Œä¸éœ€è¦åœ¨é€‰æœŸä¸­é€”å¼€å§‹æ–°çš„é€‰ä¸¾ï¼ŒåŒæ—¶ç›‘æ§FollowerèŠ‚ç‚¹çš„çŠ¶æ€ã€‚Followeråœ¨é€‰æœŸåˆ°æœŸåå‘èµ·æ–°çš„é€‰ä¸¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 func (rf *Raft) StartElection() { rf.mu.Lock() defer rf.mu.Unlock() rf.resetElectionTimer() rf.change2Candidate() done := false votes := 1 term := rf.currentTerm args := RequestVoteArgs{ Term:rf.currentTerm, CandidateID:rf.me, } for i, _ := range rf.peers { if rf.me == i { continue } // æ‹‰é€‰ç¥¨ go func(server int) { reply := RequestVoteReply{} ok := rf.sendRequestVote(server, \u0026amp;args, \u0026amp;reply) // ä¿¡æ¯ä¼ è¾“å‡ºé”™ã€æœªè·å¾—é€‰ç¥¨ï¼Œé€‰ç¥¨ä¸å¢åŠ  if !ok || !reply.VoteGranted { return } rf.mu.Lock() defer rf.mu.Unlock() // Followerã€Candidateé€‰æœŸè½åï¼Œåˆšåˆšé‡ç½®ä¸ºFollowerï¼Œé€‰ç¥¨ä¸å¢åŠ  if rf.currentTerm \u0026gt; reply.Term { return } // ç»Ÿè®¡ç¥¨æ•° votes++ // å·²ç»äº§ç”ŸLeaderï¼Œåˆ™åœæ­¢é€‰ä¸¾ï¼›é€‰ç¥¨æœªè¾¾åˆ°åŠæ•°ä»¥ä¸Šï¼Œç»§ç»­æ‹‰ç¥¨ if done || votes \u0026lt;= len(rf.peers)/2 { return } done = true // å› ä¸ºä»»æœŸçš„åŸå› è½¬æ¢æˆäº†Followerï¼Œåˆ™ä¸ä¼šæˆä¸ºLeader if rf.state != Candidate || rf.currentTerm != term { return } rf.state = Leader go rf.StartAppendEntries(true) // ç«‹å³å‘é€å¿ƒè·³ }(i) } } æ‹‰å–é€‰ç¥¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func (rf *Raft) RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) { // Your code here (2A, 2B). rf.mu.Lock() defer rf.mu.Unlock() //ç«é€‰leaderçš„èŠ‚ç‚¹ä»»æœŸå°äºç­‰äºè‡ªå·±çš„ä»»æœŸï¼Œåˆ™åå¯¹ç¥¨(ä¸ºä»€ä¹ˆç­‰äºæƒ…å†µä¹Ÿåå¯¹ç¥¨å‘¢ï¼Ÿå› ä¸ºcandidateèŠ‚ç‚¹åœ¨å‘é€requestVote rpcä¹‹å‰ä¼šå°†è‡ªå·±çš„term+1) // Leaderé€‰æœŸè½åï¼Œæ‹’ç»ç»™leaderæŠ•ç¥¨ if args.Term \u0026lt; rf.currentTerm { reply.VoteGranted = false reply.Term = rf.currentTerm return } // é€‰æœŸè½åï¼Œåˆ™åŒæ­¥é€‰æœŸï¼Œé‡ç½®çŠ¶æ€ä¸ºFollower if args.Term \u0026gt; rf.currentTerm { rf.currentTerm = args.Term rf.votedFor = -1 rf.state = Follower } reply.Term = rf.currentTerm if rf.votedFor == -1 || rf.votedFor == args.CandidateId{ rf.votedFor = args.CandidateId rf.state = Follower rf.resetElectionTimer() reply.VoteGranted = true } else { //ç¬¦åˆæŠ•ç¥¨æ¡ä»¶ï¼Œä½†æ˜¯å·²ç»æŠ•ç¥¨ç»™åˆ«çš„èŠ‚ç‚¹ reply.VoteGranted = false } } å¿ƒè·³æ£€æµ‹ Leader Electionè¿‡ç¨‹ä¸­ï¼Œå¿ƒè·³ä¿¡æ¯å®é™…ä¸Šæ˜¯ä¸€ä¸ªç©ºçš„LogEntryã€‚ä¸ºäº†åŒºåˆ†å¿ƒè·³ä¿¡æ¯ä¸æ—¥å¿—ä¿¡æ¯ï¼Œæˆ‘åœ¨è¿™é‡Œé‡‡ç”¨isHeartbeatä½œä¸ºé‰´åˆ«ã€‚\nLeaderåŠ¨ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (rf *Raft) StartAppendEntries(isHeartbeat bool) { args := RequestAppendEntriesArgs{} rf.mu.Lock() defer rf.mu.Unlock() rf.resetElectionTimer() args.LeaderTerm = rf.currentTerm args.LeaderId = rf.me // å‘é€å¿ƒè·³ for i, _ := range rf.peers { if i == rf.me { continue } go rf.AppendEntries(i, isHeartbeat, \u0026amp;args) } } Candidateä¸FolloweråŠ¨ä½œ Candidateä¸Followeråœ¨æ¥æ”¶åˆ°Leaderå‘é€çš„å¿ƒè·³ä¿¡æ¯åï¼Œæ ¹æ®é€‰æœŸæ¥å¤„ç†æ¶ˆæ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (rf *Raft) HandleAppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) { rf.mu.Lock() reply.Success = true // å‘ç°è‡ªå·±çš„é€‰æœŸæ¯”leaderçš„æ›´æ–°ï¼Œåˆ™æŠ›å¼ƒleaderæ‰€ä¼ é€’çš„æ¶ˆæ¯ if args.LeaderTerm \u0026lt; rf.currentTerm { reply.FollowerTerm = rf.currentTerm reply.Success = false rf.mu.Unlock() return } rf.mu.Unlock() // æ‰¿è®¤Leaderï¼Œå°†è‡ªå·±çš„èº«ä»½è½¬å˜ä¸ºFollower rf.mu.Lock() rf.resetElectionTimer() //é‡ç½®é€‰ä¸¾å®šæ—¶å™¨ï¼Œåœ¨é€‰ä¸¾å‘¨æœŸåˆ°æœŸå‰ï¼Œä¸ä¼šå†å‘èµ·æ–°ä¸€è½®é€‰ä¸¾ rf.state = Follower //å½“é€‰æœŸè½åleaderï¼Œåˆ™åŒæ­¥è‡ªå·±çš„é€‰æœŸ if args.LeaderTerm \u0026gt; rf.currentTerm { rf.votedFor = -1 rf.currentTerm = args.LeaderTerm reply.FollowerTerm = rf.currentTerm } rf.mu.Unlock() } ç»†èŠ‚å¤„ç† ä¸ºä»€ä¹ˆæ•°æ®ç»“æ„ä¸­ç¼ºå°‘äº†éƒ¨åˆ†è®ºæ–‡ä¸­å­˜åœ¨çš„å˜é‡ï¼Ÿ\nè¿™é‡Œåªæ˜¯é’ˆå¯¹Lab2Aæ‰€è®¾è®¡çš„æ•°æ®ç»“æ„ã€‚Lab2Açš„æµ‹è¯•ï¼Œä»…ä»…æ˜¯å…³äºLeader Electionçš„æ“ä½œï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°æ—¥å¿—å¤åˆ¶ç›¸å…³çš„æ“ä½œï¼Œå› æ­¤è¿™é‡Œçš„æ•°æ®ç»“æ„ä¼šæœ‰æ‰€ç¼ºå¤±ã€‚æ›´å…¨é¢çš„æ•°æ®ç»“æ„ä¼šåœ¨Lab2Bçš„è®°å½•ä¸­ç»™å‡ºï¼ŒåŒæ—¶é’ˆå¯¹AppendEntrieså’ŒRequestVoteå‡½æ•°ï¼Œä¹Ÿä¼šæœ‰ç›¸åº”çš„æ”¹åŠ¨\nåœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ï¼Œæœ‰èŠ‚ç‚¹æŒ‚äº†ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ\né¦–å…ˆæ˜ç¡®ï¼Œâ€œæŒ‚äº†â€çš„æ„æ€ï¼Œå¹¶ä¸æ˜¯å¹³æ—¶æ‰€è¡¨è¾¾çš„èŠ‚ç‚¹æ•…éšœï¼Œè€Œæ˜¯èŠ‚ç‚¹ä¸å…¶ä½™èŠ‚ç‚¹çš„é€šä¿¡æ–­äº†ï¼Œä½†æ˜¯èŠ‚ç‚¹ä»æœ‰å¯èƒ½ç»§ç»­è¿è¡Œï¼Œä¹Ÿå°±æ˜¯â€œæ´»åœ¨è‡ªå·±çš„ä¸–ç•Œé‡Œâ€ã€‚å› æ­¤ï¼Œæ­¤æ—¶ä¸€è‡´æ€§å‡ºç°çš„é—®é¢˜ï¼Œä¸»è¦å°±æ˜¯ä»»æœŸçš„ä¸ä¸€è‡´ï¼ˆåœ¨ä¸è€ƒè™‘æ—¥å¿—åŒæ­¥çš„æƒ…å†µä¸‹ï¼‰ã€‚æ˜ç¡®è¿™ç‚¹ä»¥åï¼Œåˆ™åˆ†ä¸¤ç§æƒ…å†µã€‚\nä¸€æ˜¯ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œè¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¸€ç›´â€œè‡ªä»¥ä¸ºæ˜¯â€çš„å‘é€å¿ƒè·³ä¿¡å·ï¼ŒåŒæ—¶ä¸ä¼šæ›´æ–°è‡ªå·±çš„é€‰æœŸï¼Œåœ¨é‡è¿ä»¥åï¼ŒèŠ‚ç‚¹ä¼šåœ¨å¿ƒè·³ä¿¡å·çš„å›å¤ä¸­å‘ç°ä»èŠ‚ç‚¹çš„é€‰æœŸï¼ˆFollowerTermï¼‰æ¯”è‡ªå·±æ›´æ–°ï¼Œå› æ­¤ä¼šæ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼Œé‡æ–°å˜ä¸ºFollowerã€‚è€Œä»èŠ‚ç‚¹å› ä¸ºä¸€ç›´æ”¶ä¸åˆ°å¿ƒè·³ä¿¡å·ï¼Œä¹Ÿå°±ä¸ä¼šæ‰§è¡ŒresetElectionTimerå‡½æ•°ï¼Œåˆ™é€‰æœŸä¼šè¿‡æœŸï¼Œè¿‡æœŸåä»èŠ‚ç‚¹åˆ™å‘èµ·æ–°ä¸€è½®çš„é€‰ä¸¾ï¼Œé€‰æœŸé€’å¢ï¼Œæ¯”æŒ‚äº†çš„ä¸»èŠ‚ç‚¹æ›´æ–°ï¼Œåç»­ä¸»èŠ‚ç‚¹é‡è¿ååˆ™ä¼šæ‹’ç»å…¶ä¿¡å·ã€‚\näºŒæ˜¯ä»èŠ‚ç‚¹æŒ‚äº†ï¼Œæ”¶ä¸åˆ°ä¸»èŠ‚ç‚¹çš„å¿ƒè·³ä¿¡æ¯ï¼Œå› æ­¤åœ¨é‡è¿ä¹‹å‰ï¼Œä¼šä¸æ–­å‘ç”Ÿé€‰æœŸè¶…æ—¶ï¼Œä¸æ–­è‡ªå¢é€‰æœŸï¼Œé‡è¿åï¼Œåˆ™ä¼šæˆä¸ºé€‰æœŸæœ€æ–°çš„èŠ‚ç‚¹ï¼Œå‚ä¸æœ€æ–°ä¸€è½®çš„é€‰ä¸¾ã€‚\nå¦ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„ç‚¹ï¼Œæ˜¯é‡è¿åæ€æ ·å¤„ç†leaderå‘é€çš„å¿ƒè·³ä¿¡æ¯ã€‚å…¶å®å›åº”ä¸ä¸å›åº”åŒºåˆ«ä¸å¤§ã€‚å¦‚æœå›åº”ï¼Œåˆ™ä¼šåŒä¸Šè¿°æƒ…å†µä¸€æ ·ä½¿leaderé‡ç½®ä¸ºfollowerï¼Œç„¶åè‡ªå·±èµ¢å¾—æ–°ä¸€è½®çš„é€‰ä¸¾ï¼›å¦‚æœä¸å›åº”ï¼Œfollowerä»ä¼šåœ¨è‡ªå·±è®¤ä¸ºçš„é€‰æœŸè¿‡æœŸåå‘èµ·æ–°ä¸€è½®é€‰ä¸¾ï¼Œæ­¤æ—¶ä¼šå‡­å€Ÿè‡ªå·±çš„ä»»æœŸä¼˜åŠ¿èµ¢å¾—é€‰ä¸¾ã€‚ä¸¤ç§æ“ä½œç»“æœæœ€ç»ˆéƒ½èƒ½å®ç°æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå› æ­¤åŒºåˆ«ä¸å¤§ã€‚\nå¦‚æœåœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†æ–°çš„ç½‘ç»œåˆ†åŒºï¼Œå‡ºç°äº†å¤šä¸ªleaderæ€ä¹ˆå¤„ç†ï¼Ÿ\nç»“è®ºæ˜¯ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚å¤šä¸ªleaderåªæ˜¯æš‚æ—¶çš„ï¼Œå½“ç½‘ç»œåˆ†åŒºåˆå¹¶åï¼Œleadersçš„é€‰æœŸä¸ä¼šå®Œå…¨ç›¸åŒã€‚è€Œé€‰æœŸæ›´æ–°çš„leaderï¼Œåˆ™ä¼šå½“é€‰åˆå¹¶ååˆ†åŒºçš„leaderï¼Œæ­¤æ—¶ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§å°±å¯ä»¥å®ç°äº†ã€‚\n","description":"","id":0,"section":"posts","tags":["MIT","Raft"],"title":"MIT6.5840â€”â€”Lab2Aï¼ˆLeader Electionï¼‰","uri":"https://example.org/posts/tech/raft/"},{"content":"å…³äºåšä¸» ğŸ‘¨â€ğŸ“ ä¸€ä¸ªæ™®é€šçš„å¤§å­¦ç”Ÿï¼Œè‡ªå­¦åç«¯ï¼Œä¸»è¯­è¨€ä¸ºGolangï¼Œåœ¨å¾®æœåŠ¡ã€å®¹å™¨ã€åˆ†å¸ƒå¼ç­‰æ–¹é¢éƒ½æœ‰æ‰€æ¶‰çŒï¼Œä¼šå†™ä¸€äº›ç®€å•çš„å‰ç«¯ä»£ç ï¼Œæœ€è¿‘åœ¨å°è¯•å†™è‡ªå·±çš„å¼€æºé¡¹ç›®ã€‚åšä¿¡è®¡ç®—æœºæºäºç”Ÿæ´»ï¼Œå–œæ¬¢å°†æŠ½è±¡å¤æ‚çš„ç†å¿µè½¬åŒ–ä¸ºç®€å•çš„è¯­è¨€ä¸å½¢è±¡çš„é€»è¾‘ï¼Œåšæ–‡å°½é‡åšåˆ°æœ‰è¶£æ˜“æ‡‚ã€‚\nå…³äºåšå®¢ ğŸ“š æ­¤åšå®¢ä¸ºä¸ªäººç¬¬äºŒä¸ªåšå®¢ï¼ŒåŸå…ˆçš„åšå®¢ï¼Œå› ä¸ºå­¦ä¸šç¹å¿™ï¼Œè®¸ä¹…æœªæ›´æ–°ã€‚æœ€è¿‘å›é¡¾ä»¥å‰çš„æ–‡ç« ï¼Œæ„Ÿè§‰ç•¥æ˜¾è‚¤æµ…ï¼Œä¸”å¾ˆå°‘åŒ…å«è‡ªå·±çš„ç†è§£ã€‚å› æ­¤ï¼Œé‡æ–°éƒ¨ç½²äº†æ­¤åšå®¢ï¼Œä»¥ä¾¿è®°å½•ä¹‹åçš„å­¦ä¹ æˆæœã€‚\n","description":"","id":1,"section":"","tags":null,"title":"å…³äºåšä¸»","uri":"https://example.org/about/"},{"content":" å‹æƒ…é“¾æ¥ ","description":"","id":2,"section":"","tags":null,"title":"æˆ‘çš„æœ‹å‹ä»¬","uri":"https://example.org/friends/"}]