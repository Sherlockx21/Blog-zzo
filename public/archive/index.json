[{"content":" æ³¨ï¼šæœ¬åšå®¢è®°å½•æœ¬äººå®ç°MIT6.5840çš„æ€è·¯ï¼Œè‹¥æœ‰é”™è¯¯ï¼Œè¯·å¤šåŒ…å«\nä¼ é€é—¨ Raftè®ºæ–‡ï¼šhttps://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf\nRaftå®ç°å‚è€ƒå®ä¾‹ï¼šhttps://github.com/hashicorp/raft\nåŸºæœ¬æ€è·¯æ¦‚è¿° MIT6.5840çš„Lab2ä¸»è¦å®ç°åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼ˆRaftï¼‰ã€‚åœ¨å®éªŒä»»åŠ¡ä¸­ï¼Œä¸»è¦åˆ†ä¸ºé¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€æŒä¹…åŒ–ã€æ—¥å¿—å‹ç¼©å››ä¸ªéƒ¨åˆ†ã€‚æœ¬äººåœ¨å®Œæˆå®éªŒçš„è¿‡ç¨‹ä¸­ï¼Œä¸»è¦æ˜¯ä»Leaderã€Candidateã€Followerä¸‰ä¸ªè§’è‰²çš„ä»»åŠ¡å‡ºå‘ï¼Œä¸æ–­å®Œå–„è¿‡ç¨‹ã€‚\nåŸºç¡€æ•°æ®ç»“æ„ æ•°æ®ç»“æ„ä¸»è¦æ˜¯æ ¹æ®è®ºæ–‡è®¾è®¡çš„ï¼Œåœ¨æŸäº›æ–¹é¢ä¸åŸæ–‡ä¼šæœ‰æ‰€ä¸åŒï¼Œè¿™é‡Œå…ˆä¸è¿‡å¤šè§£é‡Šï¼Œç›´æ¥ä¸Šæºç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 type Raft struct { mu sync.Mutex peers []*labrpc.ClientEnd persister *Persister me int dead int32 state State // èŠ‚ç‚¹è§’è‰² currentTerm int // èŠ‚ç‚¹å½“å‰ä»»æœŸ votedFor int // æŠ•ç¥¨å¯¹è±¡ log *Log // æ—¥å¿—æ–‡ä»¶ commitIndex int //æäº¤çš„æœ€åä¸€ä¸ªæ—¥å¿—çš„ç´¢å¼• lastApplied int // å‘é€çš„æœ€åä¸€ä¸ªæ—¥å¿—çš„ç´¢å¼• applyCond *sync.Cond applyManager *ApplyManager heartbeatTimeout time.Duration electionTimeout time.Duration lastElectionTime time.Time lastHeartbeatTime time.Time trackers []Tracker //ç”¨æ¥è®°å½•èŠ‚ç‚¹çš„æ—¥å¿—æäº¤ç›¸å…³ä¿¡æ¯ snapshot []byte snapshotLastIncludeIndex int // å¿«ç…§åŒ…å«çš„æœ€åä¸€ä¸ªæ—¥å¿—çš„ç´¢å¼• snapshotLastIncludeTerm int // å¿«ç…§åŒ…å«çš„æœ€åä¸€ä¸ªæ—¥å¿—çš„ä»»æœŸ } åŸºæœ¬åŠŸèƒ½ æ¥ä¸‹æ¥ï¼ŒæŒ‰ç…§è®ºæ–‡æ‰€ç»™çš„æ€è·¯è®¾è®¡æ€»ä½“æµç¨‹ã€‚åœ¨Raftç®—æ³•ä¸­ï¼ŒFollowerä¸Candidateçš„ä»»åŠ¡ï¼Œä¸»è¦æ˜¯åœ¨ä»»æœŸç»“æŸä¹‹åå‘èµ·æ–°çš„é€‰ä¸¾ã€‚åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ï¼ŒCandidateä¼šä¸æ–­å‘å…¶ä½™èŠ‚ç‚¹ç´¢å–æŠ•ç¥¨ï¼Œå¾—åˆ°å¤§å¤šæ•°ç¥¨æ•°ï¼ˆå¤§äºæ€»æ•°çš„1/2ï¼‰çš„èŠ‚ç‚¹ä¼šæˆä¸ºLeaderã€‚Leaderä¸Candidateä¼šåœ¨é€‰ä¸¾æ—¶åˆ¤æ–­è‡ªèº«ä¸äº¤äº’èŠ‚ç‚¹çš„ä»»æœŸçŠ¶æ€ï¼Œä»è€Œé‡‡å–ä¸åŒçš„è¡ŒåŠ¨ã€‚Raftç®—æ³•çš„æ‰§è¡Œé€šè¿‡tickerå‡½æ•°å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func (rf *Raft) ticker() { for !rf.killed() { rf.mu.Lock() state := rf.state rf.mu.Unlock() switch state { case Follower: fallthrough case Candidate: if rf.pastElectionTimeout() { rf.StartElection() } case Leader: isHeartbeat := false if rf.pastHeartbeatTimeout() { isHeartbeat = true rf.resetHeartbeatTimer() rf.StartAppendEntries(isHeartbeat) } rf.StartAppendEntries(isHeartbeat) } time.Sleep(tickInterval) } } Q1:è¿™é‡Œä¸ºä»€ä¹ˆä¸ç›´æ¥switch rf.stateï¼Œè€Œè¦ç”¨stateè®°å½•èŠ‚ç‚¹çŠ¶æ€ï¼ŒåŒæ—¶è¿™ä¸€ä¸ªè¿‡ç¨‹è¿˜è¦åŠ é”ï¼Ÿ\nA1:å› ä¸ºtickerå‡½æ•°å®é™…ä¸Šæ˜¯åœ¨Makeåˆ›å»ºäº†Raftå®ä½“åå¼€å¯çš„ä¸€ä¸ªåç¨‹ã€‚è€Œåœ¨æ­¤å‡½æ•°ä¸­ï¼ŒStartElectionç­‰å‡½æ•°ä¸­å­˜åœ¨å¹¶å‘ï¼Œæ¶‰åŠåˆ°èŠ‚ç‚¹çŠ¶æ€çš„è½¬æ¢ã€‚åŒæ—¶è€ƒè™‘åˆ°èŠ‚ç‚¹æ–­è”çš„å¯èƒ½ï¼Œè‹¥ä¸åŠ é”ï¼Œæ— æ³•ä¿è¯åœ¨ä¸€æ®µæ—¶é—´å†…ï¼ˆå¿ƒè·³åˆ°æœŸæˆ–é€‰ä¸¾åˆ°æœŸï¼‰èŠ‚ç‚¹çš„Stateæ°¸è¿œä¸å˜ã€‚\nä»»åŠ¡å®ç° é€‰ä¸¾ï¼ˆStartElectionï¼‰ æ ¹æ®è®ºæ–‡ï¼ŒRequestVoteé€šä¿¡å‚æ•°å®šä¹‰å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 type RequestVoteArgs struct { Term int //å‘é€è€…å½“å‰ä»»æœŸ CandidateID int //å€™é€‰äººID LastLogIndex int //æœ€åä¸€æ¡æ—¥å¿—çš„ä¸‹æ ‡ LastLogTerm int //æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸ } type RequestVoteReply struct { Term int //æ¥æ”¶è€…å½“å‰ä»»æœŸ VoteGranted bool //æ˜¯å¦æ”¶åˆ°æŠ•ç¥¨ } é€‰ä¸¾å¼€å§‹æ—¶ï¼ŒèŠ‚ç‚¹ä¼šå°†è‡ªå·±çš„èº«ä»½è½¬æ¢ä¸ºCandidateï¼Œå…ˆæŠ•è‡ªå·±ä¸€ç¥¨ï¼Œå¹¶ä¸”å‘å…¶ä½™æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å‘é€æ‹‰ç¥¨è¯·æ±‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 go func(server int) { var reply RequestVoteReply ok := rf.sendRequestVote(server, \u0026amp;args, \u0026amp;reply) if !ok || !reply.VoteGranted { //é€šä¿¡å¤±è´¥æˆ–è€…æ²¡æœ‰æ”¶åˆ°é€‰ç¥¨ï¼Œç›´æ¥ç»“æŸ return } rf.mu.Lock() defer rf.mu.Unlock() //æŠ•ç¥¨äººä»»æœŸè¿‡æœŸï¼Œé‡ç½®æŠ•ç¥¨äººçš„çŠ¶æ€ï¼ŒæŠ•ç¥¨äººåœ¨æ•°æ®è¾¾æˆä¸€è‡´å‰ä¸å‚ä¸æŠ•ç¥¨ if reply.Term \u0026lt; rf.currentTerm { return } // ç»Ÿè®¡ç¥¨æ•° votes++ if done || votes \u0026lt;= len(rf.peers)/2 { // åœ¨æˆä¸ºleaderä¹‹å‰å¦‚æœæŠ•ç¥¨æ•°ä¸è¶³éœ€è¦ç»§ç»­æ”¶é›†é€‰ç¥¨ // åœ¨æˆä¸ºleaderçš„é‚£ä¸€åˆ»ï¼Œç«‹åˆ»ç»“æŸé€‰ä¸¾ï¼Œå‘é€å¿ƒè·³ return } done = true if rf.state != Candidate || rf.currentTerm != term { return } rf.changeState(Leader) }(i) Q2ï¼šif rf.state != Candidate || rf.currentTerm != term åˆ¤æ–­çš„æ˜¯å“ªç§æƒ…å†µï¼Ÿ\nA2ï¼šé¦–å…ˆè¦æ˜ç¡®ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹æ–­è”çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹æœ¬èº«ä¸ä¸€å®šæ˜¯æ— æ³•è¿è¡Œçš„çŠ¶æ€ï¼Œå¯èƒ½åªæ˜¯RPCé€šä¿¡é”™è¯¯å¯¼è‡´çš„ã€‚æ­¤æ—¶ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ–­è”ï¼Œåˆ™ä¼šæœ‰ä¸¤ç§æƒ…å†µã€‚è‹¥èŠ‚ç‚¹ä¸ºLeaderï¼Œåˆ™ä¼šä¸æ–­å‘é€å¿ƒè·³ï¼Œä½†ä¸ä¼šæ”¶åˆ°å›å¤ï¼Œä¹Ÿå°±ä¸ä¼šæ›´æ–°ä»»æœŸã€‚åœ¨é‡è”åï¼Œä¼šå› ä¸ºè‡ªèº«ä»»æœŸæ—§è€Œå¤±å»Leaderèº«ä»½é‡ç½®ä¸ºFollowerã€‚è‹¥èŠ‚ç‚¹ä¸ºFollowerï¼Œåœ¨æ–­è”æ—¶æ¥æ”¶ä¸åˆ°å¿ƒè·³ï¼Œæ•…è‡ªèº«çš„é€‰ä¸¾è®¡æ—¶å™¨ä¼šä¸æ–­è¶…æ—¶ï¼Œå¯¼è‡´è‡ªå·±ä¸åœå‘èµ·é€‰ä¸¾ï¼Œé‡è”åè‡ªå·±ä»»æœŸä¸€å®šä¸ºæœ€æ–°ï¼Œå¯ä»¥æˆä¸ºLeaderã€‚å› ä¸ºåœ¨æ‹‰ç¥¨ä¹‹å‰ï¼ŒèŠ‚ç‚¹ä¼šå°†è‡ªå·±çš„èº«ä»½è½¬å˜ä¸ºCandidateï¼Œè¿™é‡Œçš„æ¡ä»¶å°±æ˜¯åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­æ–­è”ï¼Œå¦‚æœæ–­è”ï¼Œé‡ç½®å‰ä¸ä¼šå‚ä¸é€‰ä¸¾ã€‚\næ‹‰ç¥¨ æ‹‰ç¥¨æ˜¯æ•´ä¸ªé€‰ä¸¾çš„æ ¸å¿ƒå†…å®¹ï¼Œå†³å®šäº†æ¯ä¸ªèŠ‚ç‚¹çš„è§’è‰²ã€‚è¿™ä¸ªåŠ¨ä½œå¯¹äºæ‰€æœ‰èŠ‚ç‚¹è€Œè¨€æ˜¯å¹³ç­‰çš„ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸»è¦ä¼šå‡ºç°ä¸‹åˆ—å‡ ç§æƒ…å†µï¼š\nå‘é€è€…ä»»æœŸè¿‡æœŸï¼Œæ‹’ç»æŠ•ç¥¨ 1 2 3 4 if args.Term \u0026lt; rf.currentTerm { reply.VoteGranted = false return } æ¥æ”¶è€…ä»»æœŸè¿‡æœŸï¼Œè·Ÿæ–°æ¥æ”¶è€…ä»»æœŸ 1 2 3 4 5 6 if args.Term \u0026gt; rf.currentTerm { rf.currentTerm = args.Term reply.Term = rf.currentTerm rf.votedFor = -1 rf.state = Follower } ä¸¤è€…ä»»æœŸç›¸åŒï¼Œæ­¤æ—¶è¦æ±‚å‘é€è€…çš„æ—¥å¿—å’Œæ¥æ”¶è€…ä¸€æ ·æ–°ï¼ˆå…·ä½“è¡¨ç°ä¸ºCandidateæœ€åä¸€æ¡æ—¥å¿—ä»»æœŸæ¯”æ¥æ”¶è€…æ›´å¤§æˆ–è€…åœ¨ä»»æœŸç›¸åŒçš„æƒ…å†µä¸‹æ—¥å¿—ç´¢å¼•æ›´å¤§ï¼‰ 1 2 3 update := false update = update || args.LastLogTerm \u0026gt; rf.getLastLogTerm() update = update || args.LastLogTerm == rf.getLastLogTerm() \u0026amp;\u0026amp; args.LastLogIndex \u0026gt;= rf.log.LastLogIndex 1 2 3 4 5 6 7 8 if (rf.votedFor == -1 || rf.votedFor == args.CandidateId) \u0026amp;\u0026amp; update { rf.votedFor = args.CandidateId rf.state = Follower rf.resetElectionTimer() rf.persist() } else { reply.VoteGranted = false } è¿™é‡Œçš„æ—¥å¿—æ¯”è¾ƒå…¶å®å¯ä»¥ç±»æ¯”ä¸ºæ–‡æ¡£ï¼Œé€‰å–æ–‡æ¡£æ—¶ï¼Œç‰ˆæœ¬ï¼ˆæ—¥å¿—çš„ä»»æœŸï¼‰æ›´é«˜çš„æ–‡æ¡£å¾€å¾€æ¯”ç‰ˆæœ¬ä½çš„æ›´è´´è¿‘äºæŠ€æœ¯çš„æ›´æ–°ï¼Œè€Œåœ¨ç‰ˆæœ¬ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬æ›´è¶‹å‘äºé€‰å–å†…å®¹æ›´å…¨ï¼ˆæ—¥å¿—çš„ç´¢å¼•ï¼‰çš„æ–‡æ¡£ä½œä¸ºå‚è€ƒã€‚\nå¿ƒè·³ å…ˆå›çœ‹ä¸€ä¸‹tickerä¸­Leaderçš„åŠ¨ä½œ\n1 2 3 4 5 6 7 8 9 10 case Leader: isHeartbeat := false // å¿ƒè·³å®šæ—¶å™¨è¿‡æœŸå‘é€å¿ƒè·³ï¼Œå¦åˆ™å‘é€æ—¥å¿— if rf.pastHeartbeatTimeout() { isHeartbeat = true rf.resetHeartbeatTimer() rf.StartAppendEntries(isHeartbeat) } rf.StartAppendEntries(isHeartbeat) } å‘é€å¿ƒè·³æ˜¯leaderçš„åŠ¨ä½œ,å³æ ¹æ®å›å¤ç»“æœï¼Œè‹¥è‡ªèº«ä»»æœŸè½åï¼Œå°†è‡ªèº«çŠ¶æ€é‡è®¾ä¸ºFollowerï¼›è‹¥æ¥æ”¶æ–¹ä»»æœŸè½åæˆ–è€…é€šä¿¡æˆåŠŸï¼Œåˆ™ä¸åšä»»ä½•å¤„ç†ã€‚æ­¤å¤„å°±ä¸å†åˆ—å‡ºæºç ã€‚\nisHeartbeatåœ¨è¿™é‡Œä½œä¸ºå¿ƒè·³çš„æ ‡è®°ã€‚ä¸è¿‡ï¼ŒRaftä¸­å¿ƒè·³ä¿¡å·çš„å®ç°å®é™…ä¸Šæ˜¯é€šè¿‡åœ¨å¤åˆ¶æ—¥å¿—æ—¶å‘é€ä¸€ä¸ªç©ºçš„æ—¥å¿—æ–‡ä»¶æ¥å®ç°çš„ï¼Œå› æ­¤è¿™é‡Œçš„æ ‡è®°å¹¶ä¸æ˜¯ç»å¯¹å¿…è¦çš„ã€‚\næ¥ä¸‹æ¥ä»followerè§’åº¦çœ‹çœ‹å¯¹å¿ƒè·³æ¶ˆæ¯çš„å¤„ç†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func (rf *Raft) HandleHeartbeat(args *AppendEntriesArgs, reply *AppendEntriesReply) { rf.mu.Lock() defer rf.mu.Unlock() reply.FollowerTerm = rf.currentTerm reply.Success = true //æ‹’ç»æ—§leader if args.LeaderTerm \u0026lt; rf.currentTerm { reply.Success = false reply.FollowerTerm = rf.currentTerm return } rf.resetElectionTimer() //è½¬å˜èº«ä»½ä¸ºFollower rf.state = Follower rf.votedFor = args.LeaderID if args.LeaderTerm \u0026gt; rf.currentTerm { rf.votedFor = -1 rf.currentTerm = args.LeaderTerm reply.FollowerTerm = rf.currentTerm } } æ—¥å¿—å¤„ç† æ—¥å¿—çš„å¤„ç†åŒ…æ‹¬æ—¥å¿—çš„å¤åˆ¶ã€æäº¤ä¸å‹ç¼©ï¼Œä¸»è¦çš„éš¾ç‚¹é›†ä¸­åœ¨å¯¹äºæ—¥å¿—æ–‡ä»¶çš„ç´¢å¼•åŠä»»æœŸçš„åˆ¤æ–­ä¸å¤„ç†ã€‚\næ—¥å¿—ç”±Entryæ„æˆï¼Œæ¯ä¸ªEntryåˆæœ‰è‡ªèº«çš„ä»»æœŸã€‚\n1 2 3 4 5 6 7 8 9 10 type Entry struct { Term int Command interface{} } type Log struct { Entries []Entry // åˆå§‹çŠ¶æ€ä¸ºç©ºï¼Œä¸åŒ…å«å¿«ç…§ FirstLogIndex int LastLogIndex int } ä¸ºäº†è¿½è¸ªæ¯ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—æäº¤çš„ç›¸å…³å‚æ•°ï¼Œè¿™é‡Œè®¾è®¡trackerè¿›è¡Œå­˜å‚¨\n1 2 3 4 type Tracker struct { nextIndex int matchIndex int } å¦å¤–ï¼Œæ—¥å¿—å¿«ç…§ç›¸å…³å‚æ•°è®¾è®¡å¦‚ä¸‹\n1 2 3 snapshot []byte snapshotLastIncludeIndex int snapshotLastIncludeTerm int æ—¥å¿—å¤åˆ¶ åŒæ ·ï¼Œæ ¹æ®è®ºæ–‡ï¼Œå…ˆè®¾è®¡å‡ºä¿¡æ¯äº¤äº’çš„æ•°æ®ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type AppendEntriesArgs struct { LeaderTerm int //é¢†å¯¼äººä»»æœŸ LeaderID int //é¢†å¯¼äººID PrevLogIndex int //è¦å‘é€çš„æ‰€æœ‰æ—¥å¿—ä¸­ç¬¬ä¸€ä¸ªæ—¥å¿—çš„å‰ä¸€ä½ç´¢å¼• PrevLogTerm int //è¦å‘é€çš„æ‰€æœ‰æ—¥å¿—ä¸­ç¬¬ä¸€ä¸ªæ—¥å¿—çš„å‰ä¸€ä½ç´¢å¼•å¯¹åº”æ—¥å¿—çš„ä»»æœŸ Entries []Entry //æ—¥å¿—æœ¬ä½“ LeaderCommit int //leaderå·²ç»æäº¤çš„æœ€å¤§æ—¥å¿—ç´¢å¼• } type AppendEntriesReply struct { FollowerTerm int //è·Ÿéšè€…ä»»æœŸ Success bool //æ˜¯å¦èƒ½å¤ŸæˆåŠŸå¤åˆ¶ PrevLogIndex int //å¯¹äºfollowerå¯ä»¥ç›´æ¥å¤åˆ¶çš„å‰ä¸€ä½ç´¢å¼• PrevLogTerm int //å¯¹äºå¯¹äºfollowerå¯ä»¥ç›´æ¥å¤åˆ¶çš„å‰ä¸€ä½ç´¢å¼•å¯¹åº”æ—¥å¿—çš„ä»»æœŸ } æ—¥å¿—å¤åˆ¶çš„è¿‡ç¨‹ç›¸å¯¹å¤æ‚ï¼Œæ­¤å¤„ä»followerèŠ‚ç‚¹çš„è§’åº¦åˆ†ç±»è®¨è®ºå¤„ç†æ–¹å¼ï¼š\nleaderä»»æœŸè¿‡æ—§ï¼Œæ‹’ç»å¤åˆ¶æ—¥å¿— 1 2 3 4 if args.LeaderTerm \u0026lt; rf.currentTerm { reply.Success = false return } æ¥æ”¶è€…è‡ªèº«ä»»æœŸè¿‡æ—§ï¼Œé‡ç½®è‡ªèº«çŠ¶æ€ 1 2 3 4 5 if args.LeaderTerm \u0026gt; rf.currentTerm { rf.votedFor = -1 rf.currentTerm = args.LeaderTerm reply.FollowerTerm = rf.currentTerm } æœ¬èº«æ—¥å¿—ä¸ºç©º\nè¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯èŠ‚ç‚¹åˆšåˆšåˆå§‹åŒ–å®Œæˆï¼Œæ²¡æœ‰æ—¥å¿—è®°å½•ï¼Œæ­¤æ—¶é¢å¯¹å‘æ¥çš„æ—¥å¿—è®°å½•ï¼Œå¯ä»¥å…¨éƒ¨æ¥æ”¶ï¼›äºŒæ˜¯åˆšç»å†äº†ä¸€æ¬¡æ—¥å¿—å‹ç¼©ï¼Œæ—¥å¿—ä¿¡æ¯å­˜å‚¨åœ¨å¿«ç…§ä¸­ï¼Œè‡ªèº«çš„æ—¥å¿—ä¸ºç©ºï¼Œæ­¤æ—¶è‹¥å¿«ç…§å­˜å‚¨çš„æ—¥å¿—ä¸è¦å¤åˆ¶çš„æ—¥å¿—åˆšå¥½æ¥ä¸Šï¼Œåˆ™å¯ä»¥æ¥å—å…¨éƒ¨è®°å½•ã€‚\nåŒæ ·çš„ï¼Œå¦‚æœæ—¥å¿—ä¸ºç©ºï¼Œä½†æ˜¯è¦å¤åˆ¶çš„æ—¥å¿—ä¸å¿«ç…§æ²¡æœ‰åŠæ³•ç›¸æ¥ï¼Œåˆ™ä¸ä¼šæ¥å—è¯·æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 if args.PrevLogIndex == rf.snapshotLastIncludeIndex { rf.log.appendLogs(args.Entries...) reply.FollowerTerm = rf.currentTerm reply.Success = true reply.PrevLogIndex = rf.log.LastLogIndex reply.PrevLogTerm = rf.getLastLogTerm() return } else { reply.FollowerTerm = rf.currentTerm reply.Success = false reply.PrevLogIndex = rf.log.LastLogIndex reply.PrevLogTerm = rf.getLastLogTerm() return } æ—¥å¿—æœ¬èº«éç©º\nè¿™é‡Œåˆå¯ä»¥åˆ†å‡º3ç§æƒ…å†µï¼Œä¸€æ˜¯æ‰€è¦å¤åˆ¶çš„æ—¥å¿—åœ¨æ¥æ”¶è€…æ—¥å¿—èŒƒå›´ä¹‹å¤–ï¼Œåˆ™æ— æ³•å¤åˆ¶æ—¥å¿—ï¼›\näºŒæ˜¯åœ¨æ¥æ”¶è€…æœ¬èº«æ—¥å¿—èŒƒå›´å†…ï¼Œä¸”å‘é€çš„æ—¥å¿—æ¡ç›®ä¸æ¥æ”¶è€…æœ¬èº«æ—¥å¿—æ¡ç›®æ— å†²çªï¼ˆå¦‚å›¾ä¸­aã€bã€cã€dï¼‰ï¼Œåˆ™è¦†ç›–æ¥æ”¶è€…å¯¹åº”ç´¢å¼•ä½ç½®çš„æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 for i, entry := range args.Entries { index := args.PrevLogIndex + 1 + i if index \u0026gt; rf.log.LastLogIndex { rf.log.appendLogs(entry) } else if rf.log.getEntry(index).Term != entry.Term { ok = false *rf.log.getEntry(index) = entry } } if !ok { rf.log.LastLogIndex = args.PrevLogIndex + len(args.Entries) } è¿™é‡Œçš„æ¡ç›®å†²çªï¼Œæœ¬äººçš„ç†è§£æ˜¯è‡ªå·±å…³ç³»ï¼Œå¦‚å›¾ä¸­aã€bçš„æ—¥å¿—æ¡ç›®éƒ½æ˜¯å‘é€æ¡ç›®çš„å­é›†ï¼Œå‘é€æ¡ç›®éƒ½æ˜¯cã€dçš„æ—¥å¿—æ¡ç›®çš„å­é›†ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ—¥å¿—çš„ä»»æœŸå¯èƒ½ä¸ä¸€è‡´ï¼ŒRaftä¸­å¯¹äºè¿™ç§æƒ…å†µçš„å¤„ç†é‡‡å–è¦†ç›–å†™çš„æ–¹å¼è¾¾æˆä¸€è‡´æ€§\nä¸‰æ˜¯åœ¨æ¥æ”¶è€…æœ¬èº«æ—¥å¿—èŒƒå›´å†…ï¼Œè¦å¤åˆ¶çš„æ—¥å¿—ä¸­æœ‰ä¸€éƒ¨åˆ†ä¸æ¥æ”¶æ–¹æ—¥å¿—è®°å½•ä¸­å®Œå…¨ç›¸åŒï¼Œæ­¤æ—¶åº”è¯¥æ‰¾åˆ°å®Œå…¨ç›¸åŒçš„éƒ¨åˆ†ï¼Œå°†å…¶å†™å…¥æ¥æ”¶æ–¹æ—¥å¿—è®°å½•ï¼Œå…¶ä½™å†…å®¹èˆå»ï¼ˆå›¾ä¸­eè¦†ç›–1-5ï¼Œfè¦†ç›–1-3ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 prevIndex := args.PrevLogIndex // å¯»æ‰¾ç›¸åŒéƒ¨åˆ†æœ€åæˆªæ­¢çš„ç´¢å¼• for prevIndex \u0026gt;= rf.log.FirstLogIndex \u0026amp;\u0026amp; rf.getEntryTerm(prevIndex) == rf.log.getEntry(args.PrevLogIndex).Term { prevIndex-- } reply.FollowerTerm = rf.currentTerm reply.Success = false if prevIndex \u0026gt;= rf.log.FirstLogIndex { reply.PrevLogIndex = prevIndex reply.PrevLogTerm = rf.getEntryTerm(prevIndex) } else { reply.PrevLogIndex = rf.snapshotLastIncludeIndex reply.PrevLogTerm = rf.snapshotLastIncludeTerm } æ—¥å¿—å‹ç¼© æ—¥å¿—å‹ç¼©å¯¹äºæ¯ä¸ªèŠ‚ç‚¹è€Œè¨€åŸºæœ¬ä¸Šæ˜¯ç‹¬ç«‹çš„ï¼Œå³åœ¨æ—¥å¿—è¾¾åˆ°ä¸€å®šçš„å¤§å°åå°†å…¶å‹ç¼©ï¼Œå…¶ä¸»è¦è¿‡ç¨‹å°±æ˜¯å°†æŒ‡å®šç´¢å¼•ä¹‹å‰çš„æ—¥å¿—å…¨éƒ¨åˆ é™¤ï¼Œå°†ç›¸å…³ä¿¡æ¯è®°å½•åˆ°å¿«ç…§ä¸­ï¼Œè€Œå‰©ä¸‹çš„éƒ¨åˆ†ä½œä¸ºæ–°çš„æœ¬åœ°æ—¥å¿—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 if rf.log.FirstLogIndex \u0026lt;= index { // åªèƒ½å‹ç¼©å·²ç»æäº¤çš„æ—¥å¿— if index \u0026gt; rf.lastApplied { panic(\u0026#34;error happening\u0026#34;) } rf.snapshot = snapshot rf.snapshotLastIncludeIndex = index rf.snapshotLastIncludeTerm = rf.getEntryTerm(index) newFirstLogIndex := index + 1 if newFirstLogIndex \u0026lt;= rf.log.LastLogIndex { rf.log.Entries = rf.log.Entries[newFirstLogIndex-rf.log.FirstLogIndex:] } else { rf.log.LastLogIndex = newFirstLogIndex - 1 rf.log.Entries = make([]Entry, 0) } rf.log.FirstLogIndex = newFirstLogIndex rf.commitIndex = max(rf.commitIndex, index) rf.lastApplied = max(rf.lastApplied, index) rf.persist() for i := 0; i \u0026lt; len(rf.peers); i++ { if i == rf.me { continue } go rf.InstallSnapshot(i) } } æ­¤åŠ¨ä½œçš„æ‰§è¡Œåœ¨configæ–‡ä»¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 if (m.CommandIndex+1)%SnapShotInterval == 0 { w := new(bytes.Buffer) e := labgob.NewEncoder(w) e.Encode(m.CommandIndex) var xlog []interface{} for j := 0; j \u0026lt;= m.CommandIndex; j++ { xlog = append(xlog, cfg.logs[i][j]) } e.Encode(xlog) rf.Snapshot(m.CommandIndex, w.Bytes()) } æ—¥å¿—ä¸‹è½½ åŒæ ·å…ˆè®¾è®¡å‚æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 type InstallSnapshotArgs struct { Term int LeaderID int LastLogIndex int LastLogTerm int } type InstallSnapshotReply struct { Term int Success bool } è¿™é‡Œéœ€è¦å®ç°çš„ä¸‹è½½ä¸»è¦æŒ‡leaderå¯¹äºè½åå¾ˆå¤šçš„followeræˆ–è€…æ–°åŠ å…¥çš„èŠ‚ç‚¹å‘é€è‡ªèº«çš„å¿«ç…§ï¼Œè¾¾æˆæ—¥å¿—çš„åŒæ­¥æ“ä½œã€‚\nå¯¹äºfollowerï¼ŒåŒæ ·åˆ†æƒ…å†µè®¨è®ºï¼š\nleaderä»»æœŸè¿‡æœŸï¼Œæ‹’ç»å‹ç¼©æ—¥å¿— followerä»»æœŸè¿‡æœŸï¼Œæ›´æ–°followerçŠ¶æ€ å½“åˆå¹¶è¯·æ±‚çš„æœ€å¤§æ—¥å¿—ç´¢å¼•æ¯”å½“å‰èŠ‚ç‚¹å¿«ç…§æ‰€å­˜å‚¨çš„æœ€å¤§æ—¥å¿—ç´¢å¼•å¤§æ—¶ï¼Œå¯ä»¥åˆå¹¶æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 rf.snapshot = args.Snapshot rf.snapshotLastIncludeIndex = args.LastIncludeIndex rf.snapshotLastIncludeTerm = args.LastIncludeTerm if args.LastIncludeIndex \u0026gt;= rf.log.LastLogIndex { rf.log.Entries = make([]Entry, 0) rf.log.LastLogIndex = args.LastIncludeIndex } else { rf.log.Entries = rf.log.Entries[rf.log.getOffset(args.LastIncludeIndex+1):] } rf.log.FirstLogIndex = args.LastIncludeIndex + 1 æ—¥å¿—æäº¤ æ—¥å¿—æäº¤\nä¸€èˆ¬æ¥è¯´ï¼Œåœ¨æ—¥å¿—å¤åˆ¶ä¹‹åï¼Œä¼šè¿›è¡Œæ—¥å¿—çš„æäº¤ã€‚æ—¥å¿—æäº¤æ˜¯leaderçš„åŠ¨ä½œï¼Œå½“å…¶æ—¥å¿—è¢«å¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šæ—¶ï¼Œleaderä¼šè®¤ä¸ºè¿™äº›æ—¥å¿—å¯¹äºæ•´ä¸ªé›†ç¾¤è€Œè¨€éƒ½æ˜¯å¯æ‰§è¡Œçš„ï¼Œå› æ­¤ä¼šæäº¤è¿™äº›æ—¥å¿—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 if matchIndex \u0026lt;= rf.commitIndex { //commitIndexå‰çš„ä¸éœ€è¦æäº¤ return } // è¶Šç•Œçš„ä¸èƒ½æäº¤ if matchIndex \u0026gt; rf.log.LastLogIndex { return } if matchIndex \u0026lt; rf.log.FirstLogIndex { return } // æäº¤çš„å¿…é¡»æ˜¯æœ¬ä»»æœŸçš„æ—¥å¿— if rf.getEntryTerm(matchIndex) != rf.currentTerm { return } cnt := 1 //è‡ªåŠ¨è®¡ç®—ä¸ŠleaderèŠ‚ç‚¹çš„ä¸€ç¥¨ for i := 0; i \u0026lt; len(rf.peers); i++ { if i == rf.me { continue } if matchIndex \u0026lt;= rf.trackers[i].matchIndex { cnt++ } } if cnt \u0026gt; len(rf.peers)/2 { rf.commitIndex = matchIndex if rf.commitIndex \u0026gt; rf.log.LastLogIndex { panic(\u0026#34;\u0026#34;) } return } else { return } å…¶ä½™äº‹é¡¹ Raftä¸­éœ€è¦æŒä¹…åŒ–å“ªäº›æ•°æ®ï¼Ÿ\næœ¬äººåœ¨å®ç°è¿‡ç¨‹ä¸­æŒä¹…åŒ–çš„æ•°æ®åŒ…æ‹¬èŠ‚ç‚¹çš„ä»»æœŸã€æŠ•ç¥¨å¯¹è±¡ã€æ—¥å¿—ä»¥åŠå¿«ç…§ä¿¡æ¯ å‡ ä¸ªæ—¶é—´é—´éš”æ€ä¹ˆè®¾è®¡ï¼Ÿ\nRaftä¸­æ¶‰åŠåˆ°çš„æ—¶é—´é—´éš”åŒ…æ‹¬é€‰å¹¿æ’­æ—¶é—´ã€é€‰ä¸¾è¶…æ—¶ã€å¹³å‡æ•…éšœé—´éš”ã€‚ä¸‰è€…æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š\nå¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ \u0026lt;\u0026lt; é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ \u0026lt;\u0026lt; å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰ å…¶ä¸­ï¼Œå¹¿æ’­æ—¶é—´ä¸å¹³å‡æ•…éšœé—´éš”ä¸èƒ½ä»…ç”±ç¨‹åºå†³å®šï¼Œè€Œç¼–ç¨‹ä¸­ä¸ç®—æ³•ç›¸å…³çš„æ—¶é—´ä¸»è¦æœ‰å¿ƒè·³å‘¨æœŸä¸é€‰ä¸¾è¶…æ—¶ã€‚å¿ƒè·³å‘¨æœŸç”¨äºä¿è¯leaderçš„æƒå¨æ€§ï¼Œè®©å…¶ä½™èŠ‚ç‚¹æ£€æµ‹åˆ°leaderçš„çŠ¶æ€ï¼Œè€Œé€‰ä¸¾è¶…æ—¶åˆ™ä¸ºä¸€ä¸ªé€‰ä¸¾å‘¨æœŸã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ¯ä¸ªèŠ‚ç‚¹çš„é€‰ä¸¾å‘¨æœŸéƒ½åŒæ­¥çš„è¯ï¼Œåˆ™æŠ•ç¥¨æ—¶å¾ˆå¯èƒ½å‘ç”Ÿç¥¨æ•°çš„ç“œåˆ†ï¼Œå¯¼è‡´ä¸€ä¸ªå‘¨æœŸä¸­æ²¡æœ‰leaderã€‚ä¸ºå‡å°‘è¿™ç§æƒ…å†µï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„é€‰ä¸¾å‘¨æœŸé€šå¸¸ä¸ºä¸€ä¸ªåŸºæœ¬çš„å‘¨æœŸåŠ ä¸Šä¸€ä¸ªéšæœºæ•°ï¼Œä½¿å¾—æ¯ä¸ªèŠ‚ç‚¹å°½é‡ä¸åœ¨åŒä¸€ä¸ªæ—¶é—´å‘èµ·é€‰ä¸¾ã€‚\næ­¤æ¬¡è¯•éªŒä¸­ï¼Œæœ¬äººè®¾ç½®é€‰ä¸¾è¶…æ—¶ä¸º300msï¼Œè€Œå¿ƒè·³é—´éš”ä¸º100msï¼Œå³å¹³å‡æ¯å‘é€ä¸¤ä¸ªå¿ƒè·³ä¿¡å·åä¼šè¿›è¡Œä¸€æ¬¡é€‰ä¸¾ã€‚ å‚è€ƒèµ„æ–™ Raftè®ºæ–‡ï¼šhttps://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf\nRaftå®ç°æ€è·¯è§£æï¼šhttps://github.com/rfyiamcool/notes\n","description":"","id":0,"section":"posts","tags":["åˆ†å¸ƒå¼"],"title":"MIT6.5840","uri":"https://Sherlockx21.cn/posts/tech/mit6.5840/"},{"content":"å…³äºåšä¸» ğŸ‘¨â€ğŸ“ ä¸€ä¸ªæ™®é€šçš„å¤§å­¦ç”Ÿï¼Œè‡ªå­¦åç«¯ï¼Œä¸»è¯­è¨€ä¸ºGolangï¼Œåœ¨å¾®æœåŠ¡ã€å®¹å™¨ã€åˆ†å¸ƒå¼ç­‰æ–¹é¢éƒ½æœ‰æ‰€æ¶‰çŒï¼Œä¼šå†™ä¸€äº›ç®€å•çš„å‰ç«¯ä»£ç ï¼Œæœ€è¿‘åœ¨å°è¯•å†™è‡ªå·±çš„å¼€æºé¡¹ç›®ã€‚åšä¿¡è®¡ç®—æœºæºäºç”Ÿæ´»ï¼Œå–œæ¬¢å°†æŠ½è±¡å¤æ‚çš„ç†å¿µè½¬åŒ–ä¸ºç®€å•çš„è¯­è¨€ä¸å½¢è±¡çš„é€»è¾‘ï¼Œåšæ–‡å°½é‡åšåˆ°æœ‰è¶£æ˜“æ‡‚ã€‚\nå…³äºåšå®¢ ğŸ“š æ­¤åšå®¢ä¸ºä¸ªäººç¬¬äºŒä¸ªåšå®¢ï¼ŒåŸå…ˆçš„åšå®¢ï¼Œå› ä¸ºå­¦ä¸šç¹å¿™ï¼Œè®¸ä¹…æœªæ›´æ–°ã€‚æœ€è¿‘å›é¡¾ä»¥å‰çš„æ–‡ç« ï¼Œæ„Ÿè§‰ç•¥æ˜¾è‚¤æµ…ï¼Œä¸”å¾ˆå°‘åŒ…å«è‡ªå·±çš„ç†è§£ã€‚å› æ­¤ï¼Œé‡æ–°éƒ¨ç½²äº†æ­¤åšå®¢ï¼Œä»¥ä¾¿è®°å½•ä¹‹åçš„å­¦ä¹ æˆæœã€‚\n","description":"","id":1,"section":"","tags":null,"title":"å…³äºåšä¸»","uri":"https://Sherlockx21.cn/about/"},{"content":" å‹æƒ…é“¾æ¥ ","description":"","id":2,"section":"","tags":null,"title":"æˆ‘çš„æœ‹å‹ä»¬","uri":"https://Sherlockx21.cn/friends/"}]